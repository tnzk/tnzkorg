<hr>
<h2>title: Making Web APIs Type-safe with Aspida
distro: https://dev.to/tnzk/making-web-apis-type-safe-with-aspida-fkf</h2>
<p>Types matter. Even with the naive type system of C/C++, I used to feel somehow protected.</p>
<p>TypeScript enables for JavaScript libraries to provide their type definitions but Web APIs. Actually, majority of APIs lack precise documentation, let alone type definition.</p>
<p><a href="https://github.com/aspidajs/aspida">Aspida</a> fills this blind spot. Few HTTP client libraries on NPM provide this capability.</p>
<p>In this article, I demonstrate how we can invoke Discourse API as an example in type-safe manner.</p>
<h1>Setting up Aspida</h1>
<p>You can setup Aspida according <a href="https://github.com/aspidajs/aspida">the official README</a>.</p>
<p>Since Aspida provides just an abstraction layer for type-safety, you need to chose one of HTTP client library as its back-end. Major libraries (<a href="https://github.com/aspidajs/aspida/tree/master/packages/aspida-axios">axios</a>, <a href="https://github.com/aspidajs/aspida/tree/master/packages/aspida-ky">ky</a>, <a href="https://github.com/aspidajs/aspida/tree/master/packages/aspida-fetch">fetch</a> and <a href="https://github.com/aspidajs/aspida/tree/master/packages/aspida-node-fetch">node-fetch</a>) seem to be supported.</p>
<p>Here, I pick axios.</p>
<h1>Overview of Discourse API</h1>
<p>You may know that <a href="https://www.discourse.org/">Discourse</a> is an open source discussion platform.</p>
<p>I try accessing an instance of Discourse via its Web API and show the names of visible Categories in the forum for demonstration.</p>
<p>Discourse API is a simple RESTful API, with <a href="https://docs.discourse.org/">nice and sufficient documentation</a>. I'm not so fluent about the API, but it seems to cover almost all of its functionalities.</p>
<p>Since <a href="https://ichiji.social/@tnzk">I'm the Server Admin of a Mastodon server</a>, I chose <a href="https://discourse.joinmastodon.org/">Mastodon Meta Discussion Board</a> for an example :)</p>
<h1>Creating Type definition</h1>
<p>First of all, we need the type definition.</p>
<p>You can assign types for the response and request parameters of your favorite APIs with Aspida, by putting type definition files in <code>$REPO_ROOT/apis/</code> like:</p>
<pre><code class="language-typescript">export type CategoryList = {
    can_create_category: boolean,
    can_create_topic: boolean,
    draft: boolean,
    draft_key: string,
    draft_sequence: number,
    categories: Category[]
}

export type Category = {
    id: number,
    name: string,
    color: string,
    text_color: string
    slug: string,
    topic_count: number,
    post_count: number,
    position: number,
    description: string,
    description_text: string,
    topic_url: string,
    logo_url: string,
    background_url: string,
    read_restricted: boolean,
    permission: number,
    notification_level: string,
    can_edit: boolean,
    topic_template: string,
    has_children: boolean,
    topics_day: number,
    topics_week: number,
    topics_month: number,
    topics_year: number,
    topics_all_time: number,
    description_excerpt: string,
}

export type Methods = {
    get: {
        resBody: {
            category_list: CategoryList
        },
    }
}
</code></pre>
<p>This time I put this as <code>categories.ts</code>.</p>
<p>This is a hand-crafted type definition :tm: looking up <a href="https://docs.discourse.org/#tag/Categories">the API documentation</a> :muscle:</p>
<h1>Building the Type definition</h1>
<p>Once you have created the type definition, you need to build before using in application:</p>
<pre><code class="language-bash">$ yarn run aspida --build
</code></pre>
<p>You may be happier by having this defined in <code>package.json</code>.</p>
<h1>Invoking the API in Application</h1>
<p>Now you can invoke the API in type-safe manner! You can write your application like below.</p>
<pre><code class="language-javascript">import dotenv from "dotenv"
import axios from "axios"
import aspida from "@aspida/axios"
import api from "../apis/$api"
import type { CategoryList } from "../apis/categories"

dotenv.config()

const axiosConfig = {
    timeout: 3000,
    baseURL: 'https://discourse.joinmastodon.org',
    headers: {
        'Accept': 'application/json',
//        'Api-Username': process.env.DISCOURSE_API_USERNAME,
//        'Api-Key': process.env.DISCOURSE_API_KEY,
    }
}

let client = api(aspida(axios, axiosConfig))

;(async () => {
    client.categories.get()
        .then(response => {
            let category_list = response.data.category_list
            category_list.categories.forEach(cat => console.log(cat.name))
        })
        .catch(error => console.log(error))
})()
</code></pre>
<p>It seems you need to import types explicitly if you want enable code-completion.</p>
<p>Also, you can pass Axios options at instantiation of Aspida. I had confirmed it worked well with headers for authentication.</p>
<p>This results:</p>
<pre><code class="language-bash">$ yarn run start
Server administration
General
Core development
App development
Translation
Meta feedback
Feedback
Done in 10.56s.
</code></pre>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/i/jhg8u8v7ym1n90on6go2.png" alt=""></p>
<p>Looks good :+1:</p>
<p>You can see complete code at: https://github.com/tnzk/aspida-demo</p>
<p>You're now embraced in type system, so you won't break a thing like:</p>
<pre><code>category_list.categories.forEach(cat => console.log(cat.name * 1))
</code></pre>
<p>because this will be detected <strong>at compile time</strong>:</p>
<pre><code>src/discourse-list-category.ts:25:65 - error TS2362: The left-hand side of an arithmetic operation must be of type 'any', 'number', 'bigint' or an enum type.

25             category_list.categories.forEach(cat => console.log(cat.name * 1))
</code></pre>
<h1>Upnext</h1>
<p>Aspida has another interesting functionality which automatically build type definitions from OpenAPI Specification.</p>
<p>Since Discourse API provides it, we'll try this in next article :)</p>
